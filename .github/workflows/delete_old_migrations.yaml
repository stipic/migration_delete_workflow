name: Create and Push Branch

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  create-push-branch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: pdo, pdo_mysql

    - name: Create a new branch and push to remote
      id: create_branch
      run: |
        # Set the branch name based on the current date
        BRANCH_NAME=delete-old-migrations-$(date +%Y%m%d)

        # Ensure all remote references are up-to-date
        git fetch --all

        # Check if the branch already exists on the remote
        git ls-remote --heads origin $BRANCH_NAME
        if [ $? -eq 0 ]; then
          echo "Branch $BRANCH_NAME already exists on remote. Skipping creation."
          exit 0
        fi

        # Create a new branch locally
        git checkout -b $BRANCH_NAME

        # Stage any changes (e.g., migration deletions)
        git add migrations/

        # If no changes, exit early
        if git diff --cached --quiet; then
          echo "No old migrations to delete. Exiting."
          exit 0
        fi

        # Commit the changes
        git commit -m "Delete Symfony migrations older than 14 days"

        # Push the new branch to the remote repository
        git push --set-upstream origin $BRANCH_NAME

        # Output the branch name for later use
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

    - name: Confirm Branch Creation
      run: echo "Branch ${{ steps.create_branch.outputs.branch_name }} created and pushed successfully."
