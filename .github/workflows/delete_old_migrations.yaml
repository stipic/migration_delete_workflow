name: Delete Old Migrations

on:
  schedule:
    - cron: "0 0 1 * *"
  workflow_dispatch:

jobs:
  delete-migrations:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Git user
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Create a new branch for deleting old migrations
        id: create_branch
        run: |
          BRANCH_NAME="delete-old-migrations-$(date +%Y%m%d)"
          echo "Branch Name: $BRANCH_NAME"
          git checkout main
          git pull origin main
          git checkout -b $BRANCH_NAME
          git push --set-upstream origin $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          title: "Delete Old Migrations"
          body: "This PR deletes migration files older than 14 days."
          base: "main"
          branch: ${{ env.branch_name }}
          draft: false
          commit-message: |
            Delete migration files older than 14 days
            - Migrations older than 14 days were deleted.
          actions: |
            # Delete migrations older than 14 days
            CURRENT_DATE=$(date +%s)
            for file in ./migrations/Version*; do
              FILENAME=$(basename "$file")
              TIMESTAMP=${FILENAME//[^0-9]/}
              FILE_DATE=$(date -d "$TIMESTAMP" +%s)
              AGE=$(( (CURRENT_DATE - FILE_DATE) / 86400 ))
              if [ "$AGE" -gt 14 ]; then
                echo "Deleting file: $file (Age: $AGE days)"
                rm "$file"
              fi
            done
            git add .
            git commit -m "Delete old migrations older than 14 days"
            git push
